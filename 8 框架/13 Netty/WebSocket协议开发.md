### WebSocket协议开发应用

一直以来网络基本都是围绕HTTP的请求/响应模式而构建，之后Ajax使网络变得更加动态，但是所有的HTTP通信仍然是由客户端控制的，需要用户进行互动或者定期轮询，以便从服务器加载新数据

长期以来存在各种技术让服务器得知有新数据可用时，立即发送数据到客户端，最常用的被成为`长轮询`。客户端可以打开指向服务器的HTTP连接，而服务器会一直保持连接打开，直到发送响应。服务器只要实际拥有新数据，就会发送响应

但是，这些解决方案有个共同问题：由于HTTP协议的开销，导致不适用于低延迟应用

为了解决这个问题，WebSocket将网络套接字引入到客户端和服务端，浏览器和服务器之间可以通过套接字建立持久的连接，双方随时都可以互发数据给对方，而不是客户端控制的一个请求一个应答的模式

<h4> HTTP协议的弊端</h4>

1、HTTP协议为半双工协议。可以在客户端和服务端两个方向上传输，但是不能同时传输。意味着同一时刻，只有一个方向上的数据传递

2、消息冗长而繁琐，HTTP 消息包含`消息头`、`消息体`、`换行符`等，通常情况采用文本方式传输，相比其他的二进制通信协议，冗长而繁琐

3、针对服务器推送的黑客攻击。例如长时间轮询

轮询会要求浏览器不断地向服务器发送请求，占用大量带宽和服务器资源

<h4> WebSocket</h4>

WebSocket是HTML5开始提供的一种浏览器与服务器间进行全双工通信的网络技术

在WebSocket API中，浏览器和服务器只需要做一个握手的动作，然后浏览器和服务器之间就形成了通道，两者可以直接互相传送数据

WebSocket基于TCP双向全双工进行消息传递

<h5>WebSocket协议的主要特点</h5>

* 单一的TCP连接，采用全双工模式通信
* 对代理、防火墙和路由器透明
* 无头部信息、Cookie和身份证明
* 无安全开销
* 通过`ping/pong`帧保持链路激活
* 服务器可以主动传递消息给客户端，不再需要客户端轮询

<h4> WebSocket连接建立</h4>

建立一个WebSocket连接，客户端浏览器首先要向服务器发起一个HTTP请求，这个请求和通常的HTTP请求不同，包含了一些附加头信息，其中附加头信息`Upgrade:WebSocket`表明这是一个申请协议升级的HTTP请求

服务器解析这些附加的头信息，然后生成应答信息返回给客户端，客户端和服务端的WebSocket连接就建立起来了，双方可以通过通道自由传递信息，直到客户端或者服务端的某一方主动关闭连接

<h4> WebSocket生命周期</h4>

握手成功后，客户端和服务端通过`message`的方式进行通信，一个消息由一个或者多个帧组成，WebSocket的消息并不一定对应一个特定网络层的帧，可以被分割成多个帧或者被合并

帧都有自己对应的类型，属于同一个消息的多个帧具有相同类型的数据。

从广义上讲，数据类型可以是`文本数据`、`二进制数据`和`控制帧（协议级信令,如信号）`

<h4> WebSocket连接关闭</h4>

为了关闭WebSocket连接，客户端和服务端需要通过一个安全的 方法关闭底层TCP连接以及TLS会话。如果合适，丢弃任何可能已经接收的字节；必要时（比如受到攻击），可以通过任何可用的手段关闭连接

WebSocket的握手关闭消息带有一个状态码和一个可选的关闭原因，它必须按照协议要求发送一个`CLOSE`控制帧，当对方端收到关闭控制帧指令时，需要主动关闭WebSocket连接